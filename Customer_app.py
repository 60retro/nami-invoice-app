import streamlit as st
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime
import time
import pandas as pd
import requests
import json
import pytz
import uuid
import qrcode
import re
from io import BytesIO

# ==========================================
# ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
# ==========================================
ADMIN_PASSWORD = "34573457"

st.set_page_config(
    page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏£‡πâ‡∏≤‡∏ô Nami 345 ‡∏õ‡∏≤‡∏Å‡πÄ‡∏Å‡∏£‡πá‡∏î", 
    page_icon="üßæ",
    layout="centered",
    initial_sidebar_state="collapsed"
)

# üé® CSS: ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ + ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Dark Mode
style_senior_friendly = """
    <style>
        #MainMenu {visibility: hidden;}
        footer {visibility: hidden;}
        
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ */
        .stTextInput > div > div > input {
            font-size: 20px !important;
            height: 50px !important;
        }
        
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (Label) 
           FIX: ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á color: #000 ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏ï‡∏≤‡∏° Dark Mode ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 
        */
        .stTextInput label, .stSelectbox label {
            font-size: 20px !important;
            font-weight: bold !important;
        }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Dropdown Selectbox */
        /* ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ä‡∏°‡∏û‡∏π ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏î‡∏≥‡πÑ‡∏ß‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÄ‡∏™‡∏°‡∏≠ */
        .stSelectbox div[data-baseweb="select"] > div {
            border-color: #ff4b4b !important;
            background-color: #fff0f0 !important;
            color: #000 !important;
            height: 50px !important;
        }
        .stSelectbox div[data-baseweb="select"] span {
            font-size: 18px !important;
            color: #000 !important;
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà */
        button {
            height: 55px !important;
            font-size: 22px !important; 
            font-weight: bold !important;
        }
        
        /* ‡∏à‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏≠‡∏∂‡∏î‡∏≠‡∏±‡∏î */
        .block-container {
            padding-top: 2rem;
            padding-bottom: 5rem;
        }
    </style>
"""
st.markdown(style_senior_friendly, unsafe_allow_html=True)

# ==========================================
# üîå ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Database
# ==========================================
@st.cache_resource
def get_sheet_connection():
    scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
    key_dict = st.secrets["gcp_service_account"]
    creds = ServiceAccountCredentials.from_json_keyfile_dict(key_dict, scope)
    client = gspread.authorize(creds)
    return client

@st.cache_data(ttl=0)
def check_token_status(token_str):
    try:
        client = get_sheet_connection()
        sheet_token = client.open("Invoice_Data").worksheet("TokenDB")
        records = sheet_token.get_all_records()
        df = pd.DataFrame(records)
        if not df.empty and 'Token' in df.columns:
            df['Token'] = df['Token'].astype(str)
            match = df[df['Token'] == token_str]
            if not match.empty: return match.iloc[0]
        return None
    except: return None

def mark_token_as_used(token_str):
    try:
        client = get_sheet_connection()
        sheet_token = client.open("Invoice_Data").worksheet("TokenDB")
        cell = sheet_token.find(token_str)
        if cell: sheet_token.update_cell(cell.row, 3, "Used")
    except: pass

def send_line_message(message_text):
    try:
        if "line_messaging" in st.secrets:
            token = st.secrets["line_messaging"]["channel_access_token"]
            target_id = st.secrets["line_messaging"]["group_id"]
            url = 'https://api.line.me/v2/bot/message/push'
            headers = {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token}
            payload = {"to": target_id, "messages": [{"type": "text", "text": message_text}]}
            requests.post(url, headers=headers, data=json.dumps(payload))
    except: pass

def fix_phone_number(phone_val):
    if pd.isna(phone_val) or str(phone_val).strip() == "": return ""
    s = str(phone_val).replace("'", "").replace(",", "").replace("-", "").strip()
    if s.isdigit() and len(s) == 9: return "0" + s
    return s

def fix_tax_id(tax_val):
    s = str(tax_val).strip().replace("-", "").replace(" ", "").replace("'", "")
    if s.endswith(".0"): s = s[:-2]
    if s.isdigit() and len(s) < 13: s = s.zfill(13)
    return s

@st.cache_data
def load_thai_address_data():
    try:
        url = "https://raw.githubusercontent.com/earthchie/jquery.Thailand.js/master/jquery.Thailand.js/database/raw_database/raw_database.json"
        data = pd.read_json(url)
        return data
    except:
        return pd.DataFrame()

def smart_clean_address(addr1, addr2):
    house = str(addr1)
    dist = ""
    prov = str(addr2)
    match_amp = re.search(r'(‡πÄ‡∏Ç‡∏ï|‡∏≠‡∏≥‡πÄ‡∏†‡∏≠|‡∏≠\.)\s*([^\s]+)', prov)
    if match_amp:
        extracted = match_amp.group(0)
        dist += extracted + " "
        prov = prov.replace(extracted, "").strip()
    match_tum = re.search(r'(‡πÅ‡∏Ç‡∏ß‡∏á|‡∏ï‡∏≥‡∏ö‡∏•|‡∏ï\.)\s*([^\s]+)', house)
    if match_tum:
        extracted = match_tum.group(0)
        dist = extracted + " " + dist
        house = house.replace(extracted, "").strip()
    return house.strip(), dist.strip(), prov.strip()

# ==========================================
# üéÆ Main Logic
# ==========================================

query_params = st.query_params
token_from_url = query_params.get("token", None)

# --- Admin Section ---
if not token_from_url:
    st.title("üîí ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô Nami")
    st.info("‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô")
    with st.expander("üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code", expanded=True):
        pwd = st.text_input("‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", type="password")
        if pwd == ADMIN_PASSWORD:
            st.success("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö!")
            st.markdown("---")
            st.subheader("‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô")
            gen_amount = st.number_input("‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏ö‡∏≤‡∏ó)", min_value=1.0, step=1.0)
            if st.button("‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡πÅ‡∏•‡∏∞ ‡∏•‡∏¥‡∏á‡∏Å‡πå"):
                try:
                    token = str(uuid.uuid4())
                    client = get_sheet_connection()
                    sheet_token = client.open("Invoice_Data").worksheet("TokenDB")
                    ts = datetime.now(pytz.timezone('Asia/Bangkok')).strftime("%Y-%m-%d %H:%M:%S")
                    sheet_token.append_row([token, gen_amount, "Active", ts])
                    
                    base_url = "https://nami-invoice-app.streamlit.app" 
                    final_url = f"{base_url}/?token={token}"
                    qr = qrcode.make(final_url)
                    buf = BytesIO()
                    qr.save(buf)
                    
                    st.write("---")
                    col1, col2 = st.columns(2)
                    with col1: st.image(buf, caption=f"QR ‡∏¢‡∏≠‡∏î {gen_amount} ‡∏ö‡∏≤‡∏ó", width=250)
                    with col2:
                        st.warning("üîó **‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤**")
                        st.code(final_url, language=None)
                except Exception as e: st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")
    st.stop()

# --- Customer Validation ---
token_data = check_token_status(token_from_url)
locked_amount = 0.0

if token_data is not None:
    if token_data['Status'] == 'Active':
        locked_amount = float(token_data['Amount'])
    elif token_data['Status'] == 'Used':
        st.error("‚ùå QR Code ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß")
        st.stop()
else:
    st.error("‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö")
    st.stop()

# ==========================================
# üìù ‡∏™‡πà‡∏ß‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Customer App)
# ==========================================
st.title("üßæ ‡∏Ç‡∏≠‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ")
st.success(f"üí∞ ‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞: {locked_amount:,.2f} ‡∏ö‡∏≤‡∏ó")
st.markdown("---")

if 'last_submitted_id' not in st.session_state:
    st.session_state['last_submitted_id'] = ""

# ‡πÇ‡∏´‡∏•‡∏î Database
try:
    client = get_sheet_connection()
    sheet_db = client.open("Invoice_Data").worksheet("Customers")
    sheet_queue = client.open("Invoice_Data").worksheet("Queue")
    thai_db = load_thai_address_data() 
except:
    st.error("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô")
    st.stop()

# ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
val_name = ""
val_addr1_full = ""
val_addr2 = ""
val_phone = ""
val_dist_clean = "" 

# --------------------------------------------------------
# ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Tax ID (‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î + ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πà‡∏ô)
# --------------------------------------------------------
st.header("1Ô∏è‚É£ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤")
col_s1, col_s2 = st.columns([3, 1])

with col_s1:
    search_taxid = st.text_input("‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ 13 ‡∏´‡∏•‡∏±‡∏Å", max_chars=13, placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ...")
with col_s2:
    st.write("") # ‡πÄ‡∏ß‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å
    st.write("")
    btn_search = st.button("üîç ‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤", use_container_width=True)

# Logic ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Tax ID
if (len(search_taxid) >= 10) or btn_search:
    try:
        data = sheet_db.get_all_records()
        df = pd.DataFrame(data)
        if 'TaxID' in df.columns:
            search_key = fix_tax_id(search_taxid)
            df['TaxID_Clean'] = df['TaxID'].apply(fix_tax_id)
            res = df[df['TaxID_Clean'] == search_key]
            
            if not res.empty: 
                found_cust = res.iloc[0]
                st.info(f"‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á: {found_cust['Name']}")
                val_name = found_cust['Name']
                raw_addr1 = found_cust['Address1']
                raw_addr2 = found_cust['Address2']
                val_phone = fix_phone_number(found_cust['Phone'])
                # Clean Address
                val_addr1_full, val_dist_clean, val_addr2 = smart_clean_address(raw_addr1, raw_addr2)
            else:
                st.caption("‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)")
    except Exception as e: 
        st.error(f"‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: {e}")

st.markdown("---")

# --------------------------------------------------------
# ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå (‡πÅ‡∏ö‡∏ö Expander ‡πÄ‡∏î‡πâ‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
# --------------------------------------------------------
st.header("2Ô∏è‚É£ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå)")
st.caption("‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏¢‡∏≤‡∏ß! ‡πÅ‡∏Ñ‡πà‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≥‡∏ö‡∏•/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö")

col_z1, col_z2 = st.columns([3, 1])
with col_z1:
    # ‡πÄ‡∏û‡∏¥‡πà‡∏° key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏ä‡∏ô‡∏Å‡∏±‡∏ö state ‡∏≠‡∏∑‡πà‡∏ô
    input_zip = st.text_input("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå 5 ‡∏´‡∏•‡∏±‡∏Å", max_chars=5, placeholder="‡πÄ‡∏ä‡πà‡∏ô 11120", key="zip_input")
with col_z2:
    st.write("")
    st.write("")
    btn_zip = st.button("üöÄ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤", use_container_width=True)

# ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å (Default)
display_sub_district = val_dist_clean 
display_province = val_addr2

# Logic ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
if (len(input_zip) == 5 and not thai_db.empty) or btn_zip:
    if len(input_zip) == 5:
        thai_db['zipcode'] = thai_db['zipcode'].astype(str)
        results = thai_db[thai_db['zipcode'] == input_zip]
        
        if not results.empty:
            options = []
            for index, row in results.iterrows():
                if "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û" in row['province']:
                    label = f"‡πÅ‡∏Ç‡∏ß‡∏á{row['district']} > ‡πÄ‡∏Ç‡∏ï{row['amphoe']} > {row['province']}"
                else:
                    label = f"‡∏ï.{row['district']} > ‡∏≠.{row['amphoe']} > ‡∏à.{row['province']}"
                options.append(label)
            
            # --- üî¥ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ st.expander ‡πÅ‡∏ö‡∏ö expanded=True ---
            # ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Dropdown ‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            
            with st.expander(f"‚úÖ ‡∏û‡∏ö {len(options)} ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)", expanded=True):
                selected_option = st.radio(
                    "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡∏ö‡∏•/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠:", 
                    options, 
                    index=0, 
                    label_visibility="collapsed"
                )
            
            # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            if selected_option:
                parts = selected_option.split(" > ")
                display_sub_district = f"{parts[0]} {parts[1]}"
                display_province = f"{parts[2]} {input_zip}"
                
        else:
            st.warning("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå‡∏ô‡∏µ‡πâ")
    elif btn_zip and len(input_zip) < 5:
        st.error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏•‡∏±‡∏Å")

st.markdown("---")

# --------------------------------------------------------
# ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
# --------------------------------------------------------
st.header("3Ô∏è‚É£ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô")

# ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞ Tax ID
c_name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó", value=val_name)
c_tax = st.text_input("‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)", value=search_taxid, max_chars=13)
c_phone = st.text_input("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå", value=val_phone)

# ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•)
default_house_no = val_addr1_full
c_house_no = st.text_input("üè† ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô / ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô / ‡∏ñ‡∏ô‡∏ô / ‡∏ã‡∏≠‡∏¢", value=default_house_no, placeholder="‡πÄ‡∏ä‡πà‡∏ô 99/99 ‡∏´‡∏°‡∏π‡πà 1 ‡∏ã.‡∏ß‡∏±‡∏î‡∏Å‡∏π‡πâ")

col_a1, col_a2 = st.columns(2)
with col_a1:
    c_dist = st.text_input("‡∏ï‡∏≥‡∏ö‡∏• / ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠", value=display_sub_district, placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥")
with col_a2:
    c_prov = st.text_input("‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î / ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå", value=display_province, placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥")

st.markdown("---")
c_item = st.text_input("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° ‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà", disabled=True)
c_price = st.number_input("‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)", value=locked_amount, disabled=True)

# ==========================================
# üîò ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Final Submit)
# ==========================================
st.markdown("")
if st.button("‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏Å‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)", type="primary", use_container_width=True):
    if not c_name or not c_tax:
        st.error("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏ä‡∏∑‡πà‡∏≠' ‡πÅ‡∏•‡∏∞ '‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ'")
    elif len(c_tax) != 13:
        st.error("‚ùå '‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ' ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 13 ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô")
    elif not c_house_no: 
        st.error("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô)'")
    else:
        sig = f"{c_tax}_{c_price}_{token_from_url}"
        
        if st.session_state['last_submitted_id'] == sig:
            st.warning("‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß")
        else:
            ts = datetime.now(pytz.timezone('Asia/Bangkok')).strftime("%Y-%m-%d %H:%M:%S")
            cl_phone = fix_phone_number(c_phone)
            
            final_addr1 = f"{c_house_no} {c_dist}".strip()
            final_addr2 = c_prov.strip()
            fixed_tax_val = fix_tax_id(c_tax)
            
            try:
                # 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤ Tab Queue (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö)
                sheet_queue.append_row([ts, c_name, fixed_tax_val, final_addr1, final_addr2, str(cl_phone), c_item, 1, c_price, "Pending"])
                
                # üî¥ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏ö‡∏≠‡∏≠‡∏Å: ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤ SalesLog ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô üî¥
                # (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏Ñ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏û‡∏≠ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏î Save ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏•‡∏á SalesLog)

                # 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Tab Customers (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
                try:
                    exist_data = sheet_db.get_all_records()
                    df_ex = pd.DataFrame(exist_data)
                    need_save = True
                    if not df_ex.empty and 'TaxID' in df_ex.columns:
                        df_ex['TaxID_Clean'] = df_ex['TaxID'].apply(fix_tax_id)
                        if fixed_tax_val in df_ex['TaxID_Clean'].values:
                            need_save = False
                    
                    if need_save:
                        sheet_db.append_row([c_name, fixed_tax_val, final_addr1, final_addr2, str(cl_phone)])
                except:
                    # ‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
                    sheet_db.append_row([c_name, fixed_tax_val, final_addr1, final_addr2, str(cl_phone)])

                # 3. ‡∏õ‡∏¥‡∏î Token
                mark_token_as_used(token_from_url)
                
                # 4. ‡∏™‡πà‡∏á LINE ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                full_message = (
                    f"üîî **‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à**\n"
                    f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                    f"üë§ ‡∏ä‡∏∑‡πà‡∏≠: {c_name}\n"
                    f"üÜî Tax ID: {fixed_tax_val}\n"
                    f"üè† ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: {final_addr1} {final_addr2}\n"
                    f"üìû ‡πÇ‡∏ó‡∏£: {cl_phone}\n"
                    f"üí∞ ‡∏¢‡∏≠‡∏î: {c_price:,.2f} ‡∏ö‡∏≤‡∏ó\n"
                    f"üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: {c_item}\n"
                    f"‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: {ts}\n"
                    f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                )
                send_line_message(full_message)
                
                st.session_state['last_submitted_id'] = sig
                st.success("üéâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏±‡∏ö")
                st.balloons()
                time.sleep(3)
                st.query_params.clear() 
                st.rerun()
                
            except Exception as e:
                st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: {e}")


